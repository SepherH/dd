# 網路環境問題解決方案

## 問題描述

在進行資料庫連線測試時，遇到了以下問題：

1. 從公司網路 (220.133.138.51) 可以成功連線到家中伺服器 (59.126.99.232:3306)
2. 從家中網路卻無法連線到同一伺服器，出現 `ECONNREFUSED` 錯誤
3. 資料庫實際運行在內部網路 (192.168.50.80:3306)，透過 Omada 路由器做端口轉發

## 診斷過程

### 1. 連線測試

使用 `nmap` 工具檢查連線狀態：

```bash
nmap 59.126.99.232 -p 3306
```

結果顯示：
```
PORT     STATE  SERVICE
3306/tcp closed mysql
```

雖然可以 ping 通伺服器 IP，但 3306 端口呈現關閉狀態。

### 2. 資料庫使用者權限檢查

確認資料庫使用者權限已正確設定：

```sql
SELECT user, host FROM mysql.user;
```

結果顯示所有使用者（包括 `drunk_driving` 和 `sepher`）都允許從任何主機（`%`）連線。

### 3. 問題分析

分析後發現這是典型的 NAT 迴路問題（hairpin NAT）：

- 當從內部網路透過公網 IP 嘗試連接回到同一網路時，很多家用路由器不支援這種連線方式
- 即使已設置端口轉發，內部網路的裝置嘗試使用公網 IP 連回內部服務時仍可能失敗

## 解決方案

我們開發了一個自動環境檢測的解決方案，使系統可以自動判斷當前網路環境並使用適當的連線設定：

1. 建立環境檢測工具 `src/utils/dbEnvironment.ts`
   - 使用 `isInternalNetwork()` 函數判斷是否在內部網路
   - 通過 `getDatabaseConfig()` 函數取得適合當前環境的連線配置

2. 修改 Knex 配置文件，使用環境檢測功能
   - 更新 `knexfile.ts` 使用 `getDatabaseConfig()` 函數
   - 系統將自動選擇使用內部 IP (192.168.50.80) 或公網 IP (59.126.99.232)

3. 建立了增強版資料庫連線測試工具 `src/tools/testDbConnectionEnhanced.ts`
   - 顯示詳細的網路環境檢測結果
   - 提供更清晰的錯誤訊息和解決建議

## 使用方法

### 環境變數配置

在 `.env` 檔案中可以添加以下設定：

```
# 強制使用內部網路連線
DB_USE_INTERNAL=true

# 指定內部網路 IP（非必須，預設為 192.168.50.80）
DB_INTERNAL_HOST=192.168.50.80
```

### 測試連線

執行增強版測試工具：

```bash
bun run src/tools/testDbConnectionEnhanced.ts
```

## 未來改進

1. 透過 IP 查詢服務判斷當前環境
2. 增加連線失敗時的自動重試機制
3. 開發一個網頁界面監控資料庫連線狀態
